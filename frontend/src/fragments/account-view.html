<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/prism-table/prism-data-table.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../redux/global-store.html">
<link rel="import" href="../redux/actions/search-actions.html">
<link rel="import" href="../redux/actions/admin-actions.html">

<link rel="import" href="../components/adds-section.html">
<link rel="import" href="../components/users-section.html">
<link rel="import" href="../components/props-section.html">


<dom-module id="account-view">
  <template>
    <style include="shared-styles app-grid-style">
      :host {
        display: block;
        --app-grid-columns: 4;
        --app-grid-gutter: 12px;
        --app-grid-expandible-item-columns: 2;
        --app-grid-item-height: 50%;
      }
      div.card{
        @apply --shadow-elevation-2dp;
        padding: 8px;
        background-color: #fff;
      }
      .relative{
        position: relative;
      }
      div.overlay{
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 10;
        background-color: rgba(0,0,0,0.3);
      }
      div.results{
        max-height: 600px;
        overflow: auto;
        margin-top: 12px;
      }
      div.results-top{
        padding: 8px;
        @apply --layout-horizontal;
      }
      div.result{
        padding: 8px;
        @apply --layout-horizontal;
        height: 32px;
        border-bottom: 1px solid rgba(0,0,0,0.3);
      }
      div.result:nth-last-child(2){
        border-bottom: 0px;
      }
      span.link{
        color: var(--accent-color);
        cursor: pointer;
      }
      span.stat{
        width: 10rem;
      }
      paper-card.stat{
        height: 150px;
        width: 150px;
        margin: 8px;
      }
      .emails{
        height: calc( 100vh - 310px );
        overflow: auto;
      }
      .emails prism-table{
        background-color: #fff;
      }
      .requests{
        height: calc(100vh - 180px);
        overflow: auto;
      }
      .requests prism-table{
        background-color: #fff;
      }
      div.container{
        padding: 2rem;
      }
      paper-card.spaced{
        margin-bottom: 1rem;
      }
      iron-image.photo{
        height: 100px;
        width: 100px;
        border-radius: 50%;
      }
      paper-dropdown-menu{
        width: 27vh;
      }
      app-drawer{
        z-index: 0;
      }
    </style>
    <script>
      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    </script>
    <iron-ajax
    auto
    url="/getKeys"
    handle-as="json"
    on-response="setKeys"></iron-ajax>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>
    <app-route
        route="{{route}}"
        pattern="/user/:id"
        data="{{userRouteData}}"
        active="{{userRouteActive}}"></app-route>
    <app-route route="{{route}}" pattern="/account/payments" on-active-changed="loadPayments"></app-route>
    <app-route route="{{route}}" pattern="/account/props/:id" on-active-changed="loadPropsStats" data="{{propData}}" tail="{{tail}}"></app-route>
    <app-drawer-layout>
      <app-drawer slot="drawer">
        <app-toolbar>Menu</app-toolbar>
        <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
          <a name="start" href="/account/start">Inicio</a>
          <a name="users" href="/account/users">Usuarios</a>
          <a name="payments" href="/account/payments">Pagos por Verificar</a>
          <a name="props" href="/account/props">Propiedades</a>
          <a name="emails" href="/account/emails">Correos</a>
          <a name="requests" href="/account/requests">Peticiones</a>
          <a name="audit" href="/account/audit">Funciones realizadas</a>
          <a name="adds" href="/account/adds">Anuncios</a>
        </iron-selector>
      </app-drawer>
      <div>
        <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="start" role="main">
          <section name="start" class="vertical p2">
            <div class="horizontal m1-b">
              Administrador
            </div>
          </section>
          <section name="users">
            <users-section total="[[totalUsers]]" users="[[users]]" on-search="searchUsers" on-donate="donate" on-benefit="applyBenefit" on-delete-user="deleteUser" on-verify-email="verifyEmail"></users-section>
          </section>
          <section name="payments">
            <div class="vertical dark-primary">
              <div class="p1 horizontal">
                <span class="font-display1">Pagos</span>
              </div>
            </div>
            <prism-table>
                <prism-thead>
                    <prism-tr>
                        <prism-th>Fecha</prism-th>
                        <prism-th>Numero</prism-th>
                        <prism-th>Usuario</prism-th>
                        <prism-th>Código</prism-th>
                        <prism-th>Acción</prism-th>
                    </prism-tr>
                </prism-thead>
                <prism-tbody>
                  <template is="dom-repeat" items="[[payments]]" index-as="index">
                    <prism-tr>
                        <prism-td title="Fecha">[[localize('date','value',item.createdAt)]]</prism-td>
                        <prism-td title="Numero">[[item.transferNumber]]</prism-td>
                        <prism-td title="Usuario">[[item.payer.email]]</prism-td>
                        <prism-td title="Código">[[localize('product_code','code',item.productCode)]]</prism-td>
                        <prism-td title="Accion">
                          <paper-button id="[[item.id]]" raised class="primary" on-click="setPayment">Aprobar</paper-button>
                          <paper-button id="[[item.id]]" raised class="primary" on-click="setDeletePayment">Eliminar</paper-button>
                        </prism-td>
                    </prism-tr>
                  </template>
                </prism-tbody>
            </prism-table>
          </section>
          <section name="props">
            <props-section></props-section>
          </section>
          <section name="emails">
            <div class="vertical h-100">
              <div class="vertical dark-primary">
                <div class="p1 horizontal">
                  <span class="font-display1">Correos</span>
                  <paper-spinner active="[[emailsLoading]]"></paper-spinner>
                </div>
                <paper-tabs selected="{{emailsPage}}">
                  <paper-tab>Estadísticas</paper-tab>
                  <paper-tab>Listas</paper-tab>
                </paper-tabs>
              </div>
              <div class="vertical flex">
                <iron-pages selected="[[emailsPage]]">
                  <section class="vertical">
                    <div class="p1 horizontal">
                      <paper-radio-group selected="{{emailsTime}}">
                        <paper-radio-button name="week">La última semana</paper-radio-button>
                        <paper-radio-button name="month">El último mes</paper-radio-button>
                      </paper-radio-group>
                    </div>
                    <span class="font-display1 p1">Clientes/Inquilinos</span>
                    <div class="horizontal wrap w-100">
                        <paper-card class="stat">
                          <div class="card-content vertical">
                            <span class="font-display2">[[emailStats.userInfoRequests]]</span>
                            <span>Contactos con propietarios</span>
                          </div>
                        </paper-card>
                        <paper-card class="stat">
                          <div class="card-content vertical">
                            <span class="font-display2">[[emailStats.requestAddresses]]</span>
                            <span>Nuevos Correos</span>
                          </div>
                        </paper-card>
                        <paper-card class="stat">
                          <div class="card-content vertical">
                            <span class="font-display2">[[emailStats.props]]</span>
                            <span>Propiedades consultadas</span>
                          </div>
                        </paper-card>
                    </div>
                    <span class="font-display1 p1">Anunciantes</span>
                    <div class="horizontal wrap w-100">
                        <paper-card class="stat">
                          <div class="card-content vertical">
                            <span class="font-display2">[[emailStats.requestMessages]]</span>
                            <span>Contactos con requerimientos</span>
                          </div>
                        </paper-card>
                        <paper-card class="stat">
                          <div class="card-content vertical">
                            <span class="font-display2">[[emailStats.requestAddresses]]</span>
                            <span>Nuevos Correos</span>
                          </div>
                        </paper-card>
                    </div>
                  </section>
                  <section>
                    <div class="vertical h-100">
                      <div class="vertical p1 light-primary">
                        <span class="font-title p1">Filtros:</span>
                        <div class="horizontal p1">
                          <paper-input label="Email" value="{{emailsQuery.email}}"></paper-input>
                          <paper-input label="Lugar" value="{{emailsQuery.city}}" class="m1-x"></paper-input>
                          <paper-dropdown-menu label="Tipo">
                            <paper-listbox slot="dropdown-content" attr-for-selected="state" selected="{{emailsQuery.type}}">
                              <paper-item state="all">Todo</paper-item>
                              <paper-item state="userRequestProvide">Anunciantes</paper-item>
                              <paper-item state="userInfoRequest">Clientes/Inquilinos</paper-item>
                            </paper-listbox>
                          </paper-dropdown-menu>
                          <vaadin-date-picker value="{{emailsQuery.from}}" label="Desde" class="m1-l"></vaadin-date-picker>
                          <vaadin-date-picker value="{{emailsQuery.to}}" label="Hasta" class="m1-l"></vaadin-date-picker>
                          <paper-button raised class="accent m1-l self-center" on-tap="searchEmails">Buscar</paper-button>
                          <paper-button raised class="accent m1-l self-center" on-tap="downloadEmailList">Descargar</paper-button>
                        </div>
                      </div>
                      <div class="vertical">
                        <span class="font-title p1">Total: [[emailsCount]] direcciones</span>
                        <div class="vertical p1 emails">
                          <prism-table shadow>
                              <prism-thead>
                                  <prism-tr>
                                      <prism-th>Tipo</prism-th>
                                      <prism-th>Email</prism-th>
                                      <prism-th>Nombre</prism-th>
                                      <prism-th>Lugar</prism-th>
                                      <prism-th>Teléfono</prism-th>
                                      <prism-th>Fecha</prism-th>
                                  </prism-tr>
                              </prism-thead>
                              <prism-tbody>
                                <template is="dom-repeat" items="[[emails]]">
                                  <prism-tr>
                                      <prism-td title="Tipo">[[localize('email_record_type','value',item.type)]]</prism-td>
                                      <prism-td title="Email">[[item.email]]</prism-td>
                                      <prism-td title="Nombre">[[item.name]]</prism-td>
                                      <prism-td title="Lugar">[[item.place]]</prism-td>
                                      <prism-td title="Teléfono">[[item.phone]]</prism-td>
                                      <prism-td title="Fecha">[[item.date]]</prism-td>
                                  </prism-tr>
                                </template>
                              </prism-tbody>
                          </prism-table>
                        </div>
                      </div>
                    </div>
                  </section>
                </iron-pages>
              </div>
            </div>
          </section>
          <section name="requests">
            <div class="vertical h-100">
              <div class="vertical dark-primary">
                <div class="p1 horizontal">
                  <span class="font-display1">Peticiones</span>
                  <paper-spinner active="[[requestsLoading]]"></paper-spinner>
                </div>
              </div>
              <div class="vertical p1 light-primary">
                <span class="font-title p1">Filtros:</span>
                <div class="horizontal p1">
                  <paper-input label="Lugar" value="{{requestsQuery.place}}" class="m1-x"></paper-input>
                  <vaadin-date-picker value="{{requestsQuery.from}}" label="Desde" class="m1-l"></vaadin-date-picker>
                  <vaadin-date-picker value="{{requestsQuery.to}}" label="Hasta" class="m1-l"></vaadin-date-picker>
                  <div class="flex"></div>
                  <paper-button raised class="accent self-center" on-tap="searchRequests">Buscar</paper-button>
                </div>
              </div>
              <span class="m2-x p1-y font-subhead">Resultados: [[requests.length]]</span>
              <div class="requests p1">              
                <prism-table shadow>
                    <prism-thead>
                        <prism-tr>
                            <prism-th>Precio</prism-th>
                            <prism-th>Tipo</prism-th>
                            <prism-th>Lugar</prism-th>
                            <prism-th>Nombre</prism-th>
                            <prism-th>Teléfono</prism-th>
                            <prism-th>Email</prism-th>
                            <prism-th>Fecha</prism-th>
                            <prism-th>Acciones</prism-th>
                        </prism-tr>
                    </prism-thead>
                    <prism-tbody>
                      <template is="dom-repeat" items="[[requests]]">
                        <prism-tr>
                            <prism-td title="Precio">[[item.priceReference]]</prism-td>
                            <prism-td title="Tipo">[[item.propertyType]]</prism-td>
                            <prism-td title="Lugar">[[item.place]]</prism-td>
                            <prism-td title="Nombre">[[item.contactInfo.name]]</prism-td>
                            <prism-td title="Teléfono">[[item.contactInfo.phone]]</prism-td>
                            <prism-td title="Email">[[item.contactInfo.email]]</prism-td>
                            <prism-td title="Fecha">[[item.date]]</prism-td>
                            <prism-td title="Eliminar">
                              <paper-icon-button icon="icons:close" on-tap="openDeleteRequestDialog"></paper-icon-button>
                            </prism-td>
                        </prism-tr>
                      </template>
                    </prism-tbody>
                </prism-table>
              </div>
            </div>
          </section>
          <section name="user">
            <div class="vertical h-100">
              <div class="vertical dark-primary">
                <div class="horizontal">
                  <div class="p1 vertical flex">
                    <span class="font-display1">[[selectedUser.firstName]] [[selectedUser.lastName]]
                    </span>
                    <span>Propiedades : [[selectedUser.properties.length]]</span>
                    <template is="dom-if" if="[[selectedUser.isPlus]]" restamp="true">
                      <span>Cliente Plus : [[localize('date','value',selectedUser.plusUntil)]]</span>
                    </template>
                    <template is="dom-if" if="[[selectedUser.isPlusAnnouncer]]" restamp="true">
                      <span>Anunciante Plus : [[localize('date','value',selectedUser.plusAnnouncerUntil)]]</span>
                    </template>
                    <span>Tokens : [[selectedUser.promoteTokens]]</span>
                  </div>
                  <iron-image src="[[photoUrl]]" preload sizing="cover" class="photo self-end" placeholder="/images/user_no_photo.jpg"></iron-image>
                </div>
              </div>
              <div class="container vertical">
                <paper-card class="spaced">
                  <div class="card-content vertical">
                    <span>
                      [[selectedUser.email]]
                      <template is="dom-if" if="[[selectedUser.mailVerified]]" restamp="true">
                        <span>(verificado)</span>
                      </template>
                      <template is="dom-if" if="[[!selectedUser.mailVerified]]" restamp="true">
                        <span>(no verificado)</span>
                      </template>
                    </span>
                    <template is="dom-repeat" items="[[selectedUser.phones]]" index-as="index">
                      [[item]]
                    </template>
                    <span class="font-title">Información</span>
                    <span>Id : [[selectedUser.extraInfo.id]]</span>
                    <span>Fecha de Nacimiento : [[selectedUser.extraInfo.birthDate]]</span>
                    <span>[[selectedUser.extraInfo.location.address]] - [[selectedUser.extraInfo.location.city]]</span>
                  </div>
                </paper-card>
                <template is="dom-if" if="[[selectedUser.enterprise]]" restamp="true">
                  <paper-card class="spaced">
                    <div class="card-content vertical">
                      <span><span class="font-title">[[selectedUser.enterprise.name]]</span> [[localize('enterprise','value',selectedUserEnterprise)]]</span>
                      <span>[[selectedUser.enterprise.location.address]]</span>
                      <span>[[selectedUser.enterprise.location.city]]</span>
                    </div>
                  </paper-card>
                </template>
                <paper-card class="spaced">
                  <div class="card-content vertical">
                    <span class="font-title">Pagos</span>
                    <prism-table>
                        <prism-thead>
                            <prism-tr>
                                <prism-th>Fecha</prism-th>
                                <prism-th>Tipo</prism-th>
                                <prism-th>Metodo</prism-th>
                                <prism-th>Verificado</prism-th>
                            </prism-tr>
                        </prism-thead>
                        <prism-tbody>
                          <template is="dom-repeat" items="[[selectedUser.payments]]" index-as="index">
                            <prism-tr>
                                <prism-td title="Fecha">[[localize('date','value',item.createdAt)]]</prism-td>
                                <prism-td title="Tipo">[[item.type]]</prism-td>
                                <prism-td title="Metodo">[[item.method]]</prism-td>
                                <prism-td title="Verificado">[[item.verified]]</prism-td>
                            </prism-tr>
                          </template>
                        </prism-tbody>
                    </prism-table>
                  </div>
                </paper-card>
                <paper-card>
                  <div class="card-content">
                    <prism-table>
                        <prism-thead>
                            <prism-tr>
                                <prism-th>Titulo</prism-th>
                                <prism-th>Ciudad</prism-th>
                                <prism-th>Estado</prism-th>
                            </prism-tr>
                        </prism-thead>
                        <prism-tbody>
                          <template is="dom-repeat" items="[[selectedUser.properties]]" index-as="index">
                            <prism-tr>
                                <prism-td title="Titulo"><a id="[[item.id]]" href="/account/prop/[[item.id]]" on-click="loadProp">[[item.title]]</a></prism-td>
                                <prism-td title="Ciudad">[[item.city]]</prism-td>
                                <prism-td title="Estado">[[localize('state','value',item.state)]]</prism-td>
                            </prism-tr>
                          </template>
                        </prism-tbody>
                    </prism-table>
                  </div>
                </paper-card>
              </div>
            </div>
          </section>
          <section name="prop">
            <div class="vertical h-100">
              <div class="vertical dark-primary">
                <div class="p1 vertical">
                  <div class="horizontal">
                    <span class="font-display1 flex">
                      <span>[[selectedProp.title]] - [[localize('type','type',selectedPropType)]]</span>
                    </span>
                    <span class="font-subhead">[[localize('state','value',selectedPropState)]]</span>
                  </div>
                  <span>[[selectedProp.city]]</span>
                </div>
              </div>
              <div class="container">
                <paper-card class="spaced">
                  <div class="card-content vertical">
                    <span><b>Descipción :  </b>[[selectedProp.description]]</span>
                    <span><b>Precio :  </b>$[[selectedProp.payment]] / [[selectedProp.paymentPeriod]]</span>
                    <span><b>Area :  </b>[[selectedProp.area]]m</span>
                    <span><b>Descripción del barrio :  </b>[[selectedProp.zoneDescription]]</span>
                    <span><b>Descuento :  </b>[[selectedProp.discount]]%</span>
                    <span><b>Dirección :  </b>[[selectedProp.address]] [[selectedProp.locality]]</span>
                    <a target="_blank" href="https://www.ecuadorhouserentals.com/prop/[[selectedProp.id]]">https://www.ecuadorhouserentals.com/prop/[[selectedProp.id]]</a>
                  </div>
                </paper-card>
                <paper-card>
                  <div class="card-content vertical">
                    <span class="font-title">Usuario</span>
                    <span><a id="[[selectedProp.owner.id]]" href="/account/user/[[selectedProp.owner.id]]" on-click="loadUser">[[selectedProp.owner.firstName]][[selectedProp.owner.lastName]]</a></span>
                    <span>[[selectedProp.owner.email]]</span>
                  </div>
                </paper-card>
              </div>
            </div>
          </section>
          <section name="audit">
            <span class="font-headline s m1-b">Auditoria</span>
            <prism-table>
                <prism-thead>
                    <prism-tr>
                        <prism-th>Fecha</prism-th>
                        <prism-th>Objetivo</prism-th>
                        <prism-th>Descripcion</prism-th>
                        <prism-th>Usuario</prism-th>
                        <prism-th>Tipo</prism-th>
                    </prism-tr>
                </prism-thead>
                <prism-tbody>
                  <template is="dom-repeat" items="[[audits]]" index-as="index">
                    <prism-tr>
                        <prism-td title="Fecha">[[localize('date','value',item.createdAt)]]</prism-td>
                        <prism-td title="Objetivo">[[item.user]]</prism-td>
                        <prism-td title="Descripcion">[[item.product.description]]</prism-td>
                        <prism-td title="Usuario">[[item.employee.username]]</prism-td>
                        <prism-td title="Type">[[item.type]]</prism-td>
                    </prism-tr>
                  </template>
                </prism-tbody>
            </prism-table>
          </section>
          <section name="adds">
            <adds-section></adds-section>
          </section>
        </iron-pages>
      </div>
      <paper-dialog id="benefitsPDialog" class="vertical">
        <span class="font-display1">Beneficios</span>
        <span>Selecciona el beneficio</span>
        <span>(UP) Usuario Plus (TO) Token (AP) Anunciante Plus</span>
        <div class="benefits">
          <paper-radio-group id="benf" selected="{{benefit}}">
            <paper-radio-button name="PL001">(UP) 1 dia - $3</paper-radio-button>
            <paper-radio-button name="PL002">(UP) 1 semana - $5</paper-radio-button>
            <paper-radio-button name="PL003">(UP) 1 mes - $10</paper-radio-button>
            <paper-radio-button name="TO001">(TO) 1 propiedad - $3</paper-radio-button>
            <paper-radio-button name="TO002">(TO) 10 propeidades - $20</paper-radio-button>
            <paper-radio-button name="TO003">(TO) 25 propiedades - $37.50</paper-radio-button>
            <paper-radio-button name="TO004">(TO) 50 propiedades - $50</paper-radio-button>
            <paper-radio-button name="AP001">(AP) 1 semana - $6</paper-radio-button>
            <paper-radio-button name="AP002">(AP) 1 mes - $18</paper-radio-button>
            <paper-radio-button name="AP003">(AP) 1 año - $180</paper-radio-button>
          </paper-radio-group>
        </div>
        <div class="horizontl self-end">
          <paper-button on-tap="verify">Verificar</paper-button>
        </div>
      </paper-dialog>
      <paper-dialog id="requestDelete" class="vertical">
        <span class="font-display1">Eliminando Petición</span>
        <span>Estas seguro que deseas eliminar esta petición?</span>
        <div class="buttons">
          <paper-spinner active="[[requestsLoading]]"></paper-spinner>
          <paper-button disabled="[[requestsLoading]]" on-tap="deleteRequest">Eliminar</paper-button>
          <paper-button dialog-dismiss>Cancelar</paper-button>
        </div>
      </paper-dialog>
      <paper-dialog id="paymentDelete" class="vertical">
        <span class="font-display1">Eliminando pago</span>
        <span>Estas seguro que deseas eliminar este pago</span>
        <div class="horizontl self-end">
          <paper-button on-tap="deletePayment">Eliminar</paper-button>
          <paper-button on-tap="closeDialog">Cancelar</paper-button>
        </div>
      </paper-dialog>
      <paper-dialog id="wait" modal>
        <span>Espere...</span>
      </paper-dialog>
    </app-drawer-layout>
  </template>
  <script>
    class AccountView extends AdminMixin(SearchMixin(GlobalStoreMixin(Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior],Polymer.Element)))) {
      static get is() {return 'account-view';}
      static get properties(){
        return {
          language:{
            type:String,
            value:'es'
          },
          selectedUser:{
            type:Object,
            statePath:'search.users.selectedUser'
          },
          selectedProp:{
            type:Object,
            statePath:'search.props.selectedProp'
          },
          selectedPropState:{
            type:String,
            statePath:(state) =>{
              if(state.search.props.selectedProp){
                return state.search.props.selectedProp.state;
              }else{
                return 'n';
              }
            }
          },
          propData:{
            type:Object
          },
          filters:{
            type:Object,
            value:()=>{
              return {
                props : 'a',
                propType : 'all'
              }
            }
          },
          selectedUserEnterprise:{
            type:String,
            statePath:(state) =>{
              if(state.search.users.selectedUser.enterprise){
                return state.search.users.selectedUser.enterprise.type;
              }else{
                return 'r';
              }
            }
          },
          selectedPropType:{
            type:String,
            statePath:(state) =>{
              if(state.search.props.selectedProp){
                return state.search.props.selectedProp.type;
              }else{
                return 'n';
              }
            }
          },
          users:{
            type:Array,
            statePath:'search.users.entities'
          },
          totalUsers: {
            tyep: Number,
            statePath: 'search.users.total',
          },      
          payments:{
            type:Array,
            statePath : 'search.payments'
          },
          audits:{
            type:Array,
            statePath : 'search.audits'
          },
          stats:{
            type:Object,
            statePath:'search.stats'
          },
          loading:{
            type:Boolean,
            value:false
          },
          photoUrl:{
            type:String,
            computed:'_computePhotoUrl(selectedUser.extraInfo.photo)'
          },
          resources:{
            value:function(){
              return{
                'en':{
                  'date' : '{value,date,medium}',
                  'state' : '{value,select, p {pendiente} r {renovada} v {publicada} n {no puclicada} e {expirada}}',
                  'enterprise' : '{value,select, e {Bienes Raíces} h {Hotel} r{Corredor}}',
                  'type':'{type , select, rro {Habitación} rrs {Habitación compartida} hih {Casa Independiente} ddu {Departamento Duplex}hth {Casa Adosada/Junta} dde {Departamento} dpe {Penthouse} dsu {Suite} dlo {Loft} lfa {Quinta/Hacienda} lla {Terreno} cof{Oficina} cse {Local Comercial} cst {Bodega} cga{Garage} cba {Galpon} rsr {Habitación Compartida} tsm {Habitación de Hotel Simple} tdb {Habitación de Hotel doble} ths {Suite de Hotel} tma {Habitacion de Hotel matrimonial} other{}}',
                  'product_code':'{code,select, PL001{Usuario Plus (1 día)} PL002 {Usuario Plus (1 semana)}  PL003 {Usuario Plus (1 mes)}  TO001{1 Token}  TO002 {10 Tokens} TO003 {25 Tokens} TO004{50 Tokens} AP001 {Anunciante Plus (1 semana)} AP002 {Anunciante Plus (1 mes)} AP003 {Anunciante Plus (1 año)} other{}}',
                  'date':'{value,date,medium}',
                  'email_record_type':'{value,select,userInfoRequest{Usuario} userRequestProvide{Anunciante} other{}}'

                },
                'es':{
                  'date' : '{value,date,medium}',
                  'state' : '{value,select,p {pendiente} r {renovada} v {publicada} n {no puclicada} e {expirada}}',
                  'enterprise' : '{value,select, e {Bienes Raíces} h {Hotel} r{Corredor}}',
                  'type':'{type , select, rro {Habitación} rrs {Habitación compartida} hih {Casa Independiente} ddu {Departamento Duplex}hth {Casa Adosada/Junta} dde {Departamento} dpe {Penthouse} dsu {Suite} dlo {Loft} lfa {Quinta/Hacienda} lla {Terreno} cof{Oficina} cse {Local Comercial} cst {Bodega} cga{Garage} cba {Galpon} rsr {Habitación Compartida} tsm {Habitación de Hotel Simple} tdb {Habitación de Hotel doble} ths {Suite de Hotel} tma {Habitacion de Hotel matrimonial} other{}}',
                  'product_code':'{code,select, PL001{Usuario Plus (1 día)} PL002 {Usuario Plus (1 semana)}  PL003 {Usuario Plus (1 mes)}  TO001{1 Token}  TO002 {10 Tokens} TO003 {25 Tokens} TO004{50 Tokens} AP001 {Anunciante Plus (1 semana)} AP002 {Anunciante Plus (1 mes)} AP003 {Anunciante Plus (1 año)} other{}}',
                  'date':'{value,date,medium}',
                  'email_record_type':'{value,select, userInfoRequest {Usuario} userRequestProvide{Anunciante} other{}}'
                }
              }
            }
          },
          route:String,
          page:String,
          payment:String,
          benefit : {
            type : String,
            value : 'PL001'
          },
          emailsPage:{
            type:String,
            value:'0'
          },
          emailsTime:{
            type:String,
            value:'week',
            observer:'_emailsTimeChanged'
          },
          emailsQuery:{
            type:Object,
            value:()=>{
              return {
                from: (new Date()).toFormat('MM/DD/YYYY'),
                to: (new Date()).remove({weeks:1}).toFormat('MM/DD/YYYY'),
                email:'',
                city:'',
                type:''
              }
            }
          },
          emails:{
            type:Array,
            statePath:'search.emails.records'
          },
          emailsCount:{
            type:Number,
            statePath:(state)=>{
              return state.search.emails.records.length;
            }
          },
          emailStats:{
            type:Object,
            statePath:'search.emails.stats'
          },
          emailsLoading:{
            type:Boolean,
            value:false
          },
          requests:{
            type:Array,
            statePath:'search.requests.records'
          },
          requestsQuery:{
            type:Object,
            value:()=>{
              return {
                from: (new Date()).toFormat('MM/DD/YYYY'),
                to: (new Date()).remove({weeks:1}).toFormat('MM/DD/YYYY'),
                place:''
              }
            }
          },
          selectedRequest:{
            type:String,
            statePath:'search.requests.selectedRequest'
          },
          requestsLoading:{
            type:Boolean,
            value:false
          },
          userRouteData:Object,
          userRouteActive: Boolean
        }
      }
      static get observers() {
        return [
          '_routePageChanged(routeData.page)','_selectedUserChange(userRouteData.id)',
        ];
      }
      searchUsers(e){
        var userQuery=e.detail;
        if(userQuery.from && userQuery.to){
          userQuery.from = new Date(userQuery.from).getTime();
          userQuery.to = new Date(userQuery.to).getTime();
        }
        this.dispatch('searchUsers',userQuery,(e)=>{
          if(e)return showMessage('Error en la búsqueda');
        });
      }
      getUser(e){
        var id = e.model.__data.item.id;
        this.selectUser(id);
      }
      selectUser(id){
        this.loading=true;
        this.dispatch('selectUser',id,(e)=>{
          this.loading=false;
          if(e)return showMessage('Error obteniendo la información del usuario');
        });
      }
      _routePageChanged(page){
        if(page===undefined){
          return;
        }
        if(page===''){
          this.page='start';
        }else{
          this.page=page;
          if(page == 'payments'){
            this.dispatch('loadPayments');
          }
          if(page == 'audit'){
            this.dispatch('loadAudits');
          }
          if(page ==='emails'){
            this.loadEmailStats();
          }
          if(page === 'adds'){
            this.dispatch('loadAdds',()=>{});
          }
        }
      }
      _selectedUserChange(id){
        if(!id) return ;
        if(!this.userRouteActive) return;
        this.dispatch('loadSingleUser', id);
      }
      
      setDeletePayment(e){
        this.set('paymentToDelete',e.target.id);
        this.$.paymentDelete.open();
      }
      setPayment(e){
        this.set('payment',e.target.id);
        this.$.benefitsPDialog.open();
      }
      deleteUser(e){
        this.dispatch('deleteUser',e.detail.id,(err)=>{
          if(err)return showMessage('Hubo un error');
          showMessage('Usuario eliminado');
          e.cb();
          this.searchUsers({detail:this.$.usersSection.query});
        })
      }
      deletePayment(e){
        this.dispatch('deletePayment',this.paymentToDelete,(err)=>{
          if (err) return showMessage(err);
          showMessage('Pago eliminado');
          this.loadPayments();
          this.$.paymentDelete.close();
        })
      }
      _computePhotoUrl(photo){
        if(photo){
          if(photo.indexOf('http')>=0){
            return photo;
          }else{
            return 'http://res.cloudinary.com/hmeefwd4l/image/upload/'+photo+'.jpg';
          }
        }else{
          return null;
        }
      }
      applyBenefit(e){
        let d = e.detail;
        this.$.wait.open();
        this.dispatch('promoteToPlus',d.id,d.code,(err)=>{
          if(err)return showMessage('Hubo un error');
          showMessage('Beneficio agregado');
          d.cb();
          this.$.wait.close();
        });
      }
      verify(e){
        this.$.benefitsPDialog.close();
        this.$.wait.open();
        this.dispatch('verifyPayment',this.payment,this.benefit,(err)=>{
          showMessage('Beneficio agregado');
          this.dispatch('loadPayments');
          this.$.wait.close();
        });
      }
      verifyEmail(e){
        let d = e.detail;
        this.dispatch('verifyEmail',d.id,(err)=>{
          if(err)return showMessage('Error verificando el email');
          showMessage('Mail verificado');
          d.cb();
        });
      }
      loadPayments(){
        this.dispatch('loadPayments');
      }
      loadPropsStats(){
        var prop = this.route.path.split('/prop/');
        if(prop[1]){
          this.dispatch('loadSingleProp',prop[1]);
        }
      }
      donate(e){
        let d = e.detail;
        this.$.wait.open();
        this.dispatch('donateBenefit',d.id,d.code,(err)=>{
          if(err)return showMessage('Hubo un error');
          showMessage('Beneficio donado');
          d.cb();
          this.$.wait.close();
        });
      }
      _emailsTimeChanged(newVal,oldVal){
        if(!newVal)return;
        this.loadEmailStats();
      }
      loadEmailStats(){
        this.emailsLoading=true;
        this.dispatch('getEmailStats',this.emailsTime,(error)=>{
          if(error)return showMessage('Error cargando las estadísticas de los emails');
          this.emailsLoading=false;
        })
      }
      searchEmails(){
        this.emailsLoading=true;
        this.dispatch('updateEmailQuery',this.emailsQuery);
        this.dispatch('getEmailList',this.emailsQuery,(err)=>{
          if(err)return showMessage('Hubo un error obteninedo la lista');
          this.emailsLoading=false;
        });
      }
      searchRequests(){
        this.requestsLoading=true;
        this.dispatch('searchRequests',this.requestsQuery,(err)=>{
          if(err)return showMessage('Hubo un error obteninedo la lista');
          this.requestsLoading=false;
        });
      }
      deleteRequest(){
        this.requestsLoading=true;
        this.dispatch('deleteRequest',this.selectedRequest,(err)=>{
          this.requestsLoading=false;
          console.log(err);
          if(err)return showMessage('Hubo un error eliminando la petición');
          this.$.requestDelete.close();
        });
      }
      openDeleteRequestDialog(e){
        let id = e.model.__data.item.id;
        this.dispatch('selectRequest',id);
        this.$.requestDelete.open();
      }
      loadUser(e){
        this.dispatch('loadSingleUser',e.target.id);
      }
      loadProp(e){
        this.dispatch('loadSingleProp',e.target.id);
      }
      downloadEmailList(){
        var emailsQuery = this.emailsQuery;
        var result = window.location.origin + '/stats/get-email-list?';
        if(emailsQuery.from){
          result+='from='+emailsQuery.from+'&';
        }
        if(emailsQuery.to){
          result+='to='+emailsQuery.to+'&';
        }
        if(emailsQuery.email){
          result+='email='+emailsQuery.email+'&';
        }
        if(emailsQuery.city){
          result+='city='+emailsQuery.city+'&';
        }
        if(emailsQuery.type){
          result+='type='+emailsQuery.type+'&';
        }
        window.open(result, '_blank');
      }
      sortByProps(){
        var users = this.users.slice();
        if(this.filters.props == 'a'){
          users.sort((a,b)=>{
            if(b.properties.length>a.properties.length){
              return -1;
            }
            if(b.properties.length<a.properties.length){
              return 1;
            }
            return 0;
          });
        }else{
          users.sort((a,b)=>{
            if(b.properties.length>a.properties.length){
              return 1;
            }
            if(b.properties.length<a.properties.length){
              return -1;
            }
            return 0;
          });
        }
        this.set('users',users);
      }
      closeDialog(e){
        e.path[4].close();
      }
      setKeys(e){
        var keys = e.detail.__data.response;
        window.fbAsyncInit = ()=> {
          FB.init({
            appId      : keys.facebook,
            xfbml      : true,
            version    : 'v2.8',
            status     : true
          });
        };
      }
    }
    window.customElements.define(AccountView.is, AccountView);
  </script>
</dom-module>
